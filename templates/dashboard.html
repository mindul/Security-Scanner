<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>

<body class="dashboard-body">
    <div class="sidebar">
        <div class="logo">SEC-SCAN</div>
        <button class="menu-btn active" onclick="showScanner('weblogic')">
            WebLogic (CVE-2017-10271)
        </button>
        <button class="menu-btn" onclick="showScanner('port')">
            IP Port Scan
        </button>
        <button class="menu-btn" onclick="showScanner('ssl')">
            SSL/TLS Scanner
        </button>
        <button class="menu-btn" onclick="showScanner('malicious')">
            Malicious Link Scanner
        </button>
        <button class="menu-btn" onclick="showScanner('arp')">
            ARP Scanner (root 권한 필요)
        </button>
        <!-- Future scanners can be added here -->
    </div>

    <div class="main-content">
        <!-- WebLogic Panel -->
        <div id="weblogic-scanner" class="scanner-panel active">
            <h2>WebLogic Vulnerability Scanner</h2>
            <div class="input-group">
                <label for="weblogic-target">Target IP / CIDR:</label>
                <input type="text" id="weblogic-target" placeholder="e.g. 192.168.1.10 or 192.168.1.0/24">
                <button onclick="startWebLogicScan()" class="btn-scan">SCAN TARGET</button>
            </div>
            <div class="results-area">
                <h3>Scan Results</h3>
                <div id="weblogic-results" class="console-output">
                    <p class="status-line">System Ready...</p>
                </div>
            </div>
        </div>

        <!-- Port Scanner Panel -->
        <div id="port-scanner" class="scanner-panel" style="display:none;">
            <h2>IP Port Scanner</h2>
            <div class="input-group">
                <label for="port-target">Target IP / CIDR:</label>
                <input type="text" id="port-target" placeholder="e.g. 127.0.0.1 or 192.168.1.0/24">

                <label for="port-range">Ports (Range 1-1024, List 80 443, or Single 80):</label>
                <input type="text" id="port-range" placeholder="e.g. 1-100 or 80 443 8080" value="1-1024">

                <button onclick="startPortScan()" class="btn-scan">SCAN PORTS</button>
            </div>
            <div class="results-area">
                <h3>Open Ports</h3>
                <div id="port-results" class="console-output">
                    <p class="status-line">System Ready...</p>
                </div>
            </div>
        </div>

        <!-- SSL Scanner Panel -->
        <div id="ssl-scanner" class="scanner-panel" style="display:none;">
            <h2>SSL/TLS Scanner</h2>
            <div class="input-group">
                <label for="ssl-target">Target Host (Domain or IP):</label>
                <input type="text" id="ssl-target" placeholder="e.g. example.com">

                <label for="ssl-port">Port:</label>
                <input type="number" id="ssl-port" value="443">

                <button onclick="startSSLScan()" class="btn-scan">SCAN SSL/TLS</button>
            </div>
            <div class="results-area">
                <h3>Analysis Results</h3>
                <div id="ssl-results" class="console-output">
                    <p class="status-line">System Ready...</p>
                </div>
            </div>
        </div>

        <!-- Malicious Link Scanner Panel -->
        <div id="malicious-scanner" class="scanner-panel" style="display:none;">
            <h2>Malicious Link Scanner</h2>
            <div class="input-group">
                <label for="malicious-target">Suspicious URL:</label>
                <input type="text" id="malicious-target"
                    placeholder="e.g. http://bit.ly/sus-link or http://suspicious-site.com">
                <button onclick="startMaliciousScan()" class="btn-scan">SCAN URL</button>
            </div>
            <div class="results-area">
                <h3>Scan Results</h3>
                <div id="malicious-results" class="console-output">
                    <p class="status-line">System Ready...</p>
                </div>
            </div>
        </div>

        <!-- ARP Scanner Panel -->
        <div id="arp-scanner" class="scanner-panel" style="display:none;">
            <h2>ARP Network Scanner</h2>
            <div class="input-group">
                <label for="arp-target">Target IP Range (CIDR):</label>
                <input type="text" id="arp-target" placeholder="e.g. 192.168.0.1/24">
                <button onclick="startARPScan()" class="btn-scan">SCAN PROBE</button>
            </div>
            <div class="results-area">
                <h3>Discovered Devices</h3>
                <div id="arp-results" class="console-output">
                    <p class="status-line">System Ready...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showScanner(type) {
            // Hide all panels
            document.querySelectorAll('.scanner-panel').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));

            // Show selected
            if (type === 'weblogic') {
                document.getElementById('weblogic-scanner').style.display = 'block';
                document.querySelectorAll('.menu-btn')[0].classList.add('active'); // Assumption: First button is WebLogic
            } else if (type === 'port') {
                document.getElementById('port-scanner').style.display = 'block';
                document.querySelectorAll('.menu-btn')[1].classList.add('active'); // Assumption: Second is Port
            } else if (type === 'ssl') {
                document.getElementById('ssl-scanner').style.display = 'block';
                document.querySelectorAll('.menu-btn')[2].classList.add('active'); // Corrected index for SSL button
            } else if (type === 'malicious') {
                document.getElementById('malicious-scanner').style.display = 'block';
                document.querySelectorAll('.menu-btn')[3].classList.add('active');
            } else if (type === 'arp') {
                document.getElementById('arp-scanner').style.display = 'block';
                document.querySelectorAll('.menu-btn')[4].classList.add('active');
            }
        }

        async function startWebLogicScan() {
            const target = document.getElementById('weblogic-target').value;
            const resultsDiv = document.getElementById('weblogic-results');

            if (!target) {
                alert("Please enter a target IP or CIDR range.");
                return;
            }

            resultsDiv.innerHTML = '<p class="status-line blinking">Scanning target(s)...</p>';

            try {
                const response = await fetch('/api/scan/weblogic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ target: target })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                resultsDiv.innerHTML = ''; // Clear loading message

                if (data.error) {
                    resultsDiv.innerHTML += `<p class="error">ERROR: ${data.error}</p>`;
                } else if (data.results && data.results.length > 0) {
                    data.results.forEach(res => {
                        const statusClass = res.vulnerable ? 'vuln' : 'safe';
                        const statusText = res.vulnerable ? '[!] VULNERABLE' : '[*] SAFE';
                        resultsDiv.innerHTML += `
                            <div class="result-line ${statusClass}">
                                <span class="target">${res.target}</span>
                                <span class="status">${statusText}</span>
                                <span class="detail">(${res.reason})</span>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML = '<p>No results found.</p>';
                }

            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">System Error: ${error.message}</p>`;
            }
        }

        async function startPortScan() {
            const target = document.getElementById('port-target').value;
            const ports = document.getElementById('port-range').value;
            const resultsDiv = document.getElementById('port-results');

            if (!target) {
                alert("Please enter a target IP or CIDR.");
                return;
            }

            resultsDiv.innerHTML = '<p class="status-line blinking">Scanning ports... (This may take a moment)</p>';

            try {
                const response = await fetch('/api/scan/ports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, ports: ports })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                resultsDiv.innerHTML = '';

                if (data.error) {
                    resultsDiv.innerHTML += `<p class="error">ERROR: ${data.error}</p>`;
                } else if (data.results && data.results.length > 0) {
                    data.results.forEach(res => {
                        resultsDiv.innerHTML += `
                            <div class="result-line safe">
                                <span class="target">${res.ip}:${res.port}</span>
                                <span class="status">OPEN</span>
                                <span class="detail">(${res.service})</span>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML = '<p>No open ports found in range.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">System Error: ${error.message}</p>`;
            }
        }

        async function startSSLScan() {
            const target = document.getElementById('ssl-target').value;
            const port = document.getElementById('ssl-port').value;
            const resultsDiv = document.getElementById('ssl-results');

            if (!target) {
                alert("Please enter a target host.");
                return;
            }

            resultsDiv.innerHTML = '<p class="status-line blinking">Analyzing SSL/TLS Configuration...</p>';

            try {
                const response = await fetch('/api/scan/ssl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, port: port })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const res = data.results;

                resultsDiv.innerHTML = '';

                if (data.error) {
                    resultsDiv.innerHTML += `<p class="error">ERROR: ${data.error}</p>`;
                } else if (res) {
                    // Certificate Info
                    if (res.certificate) {
                        const cert = res.certificate;
                        const subject = cert.subject ? Object.values(cert.subject).join(' ') : 'N/A';
                        resultsDiv.innerHTML += `
                            <div class="result-line safe">
                                <span class="status">Certificate</span>
                                <span class="detail">Matches ${subject}</span>
                            </div>
                            <div class="result-line">
                                <span class="detail">Expires: ${cert.valid_until} (${cert.days_remaining} days left)</span>
                            </div>
                        `;
                    }

                    // Vulnerabilities
                    if (res.vulnerabilities && res.vulnerabilities.length > 0) {
                        res.vulnerabilities.forEach(vuln => {
                            resultsDiv.innerHTML += `
                                <div class="result-line vuln">
                                    <span class="status">[VULNERABILITY]</span>
                                    <span class="detail">${vuln}</span>
                                </div>
                            `;
                        });
                    } else {
                        resultsDiv.innerHTML += `
                            <div class="result-line safe">
                                <span class="status">[SECURE]</span>
                                <span class="detail">No obvious vulnerabilities found.</span>
                            </div>
                        `;
                    }

                    // Protocols
                    if (res.protocols) {
                        let protocols = Object.entries(res.protocols)
                            .filter(([_, supported]) => supported)
                            .map(([proto, _]) => proto)
                            .join(', ');
                        resultsDiv.innerHTML += `
                            <div class="result-line">
                                <span class="status">Protocols</span>
                                <span class="detail">${protocols}</span>
                            </div>
                        `;
                    }

                } else {
                    resultsDiv.innerHTML = '<p>No results returned.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">System Error: ${error.message}</p>`;
            }
        }

        async function startMaliciousScan() {
            const target = document.getElementById('malicious-target').value;
            const resultsDiv = document.getElementById('malicious-results');

            if (!target) {
                alert("Please enter a URL.");
                return;
            }

            resultsDiv.innerHTML = '<p class="status-line blinking">Analyzing URL...</p>';

            try {
                const response = await fetch('/api/scan/malicious', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: target })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                resultsDiv.innerHTML = '';

                if (data.error) {
                    resultsDiv.innerHTML += `<p class="error">ERROR: ${data.error}</p>`;
                } else {
                    const statusClass = data.is_malicious ? 'vuln' : 'safe';
                    const statusText = data.is_malicious ? '[!] DANGEROUS' : '[*] SAFE';

                    // Display Snapshot
                    if (data.snapshot_url) {
                        resultsDiv.innerHTML += `
                            <div class="snapshot-container" style="margin-bottom: 20px;">
                                <p class="detail">Site Snapshot:</p>
                                <img src="${data.snapshot_url}" alt="Site Snapshot" style="width:100%; max-width:600px; border: 1px solid #00ff00; box-shadow: 0 0 10px #00ff00;">
                            </div>
                        `;
                    }

                    resultsDiv.innerHTML += `
                        <div class="result-line ${statusClass}">
                            <span class="status">${statusText}</span>
                            <span class="detail">Confidence: ${data.confidence}</span>
                        </div>
                        <div class="result-line">
                            <span class="detail">Original URL: ${data.original_url}</span>
                        </div>
                        <div class="result-line">
                            <span class="detail">Final Destination: ${data.final_url}</span>
                        </div>
                        <div class="result-line">
                            <span class="detail">Analysis: ${data.reason}</span>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">System Error: ${error.message}</p>`;
            }
        }

        async function startARPScan() {
            const target = document.getElementById('arp-target').value;
            const resultsDiv = document.getElementById('arp-results');

            if (!target) {
                alert("Please enter a target IP range (CIDR).");
                return;
            }

            resultsDiv.innerHTML = '<p class="status-line blinking">Scanning Network (ARP Probing)...</p>';

            try {
                const response = await fetch('/api/scan/arp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.error) {
                        throw new Error(errorData.error);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                resultsDiv.innerHTML = '';

                if (data.error) {
                    resultsDiv.innerHTML += `<p class="error">ERROR: ${data.error}</p>`;
                } else if (data.results && data.results.length > 0) {
                    // Header
                    resultsDiv.innerHTML += `
                        <div class="result-line" style="font-weight:bold; border-bottom: 1px solid #333; margin-bottom:10px;">
                            <span class="target" style="width: 200px; display:inline-block;">IP Address</span>
                            <span class="detail">MAC Address</span>
                        </div>
                    `;

                    data.results.forEach(res => {
                        resultsDiv.innerHTML += `
                            <div class="result-line safe">
                                <span class="target" style="width: 200px; display:inline-block;">${res.ip}</span>
                                <span class="detail">${res.mac}</span>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML = '<p>No devices found.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">System Error: ${error.message}</p>`;
            }
        }
    </script>
</body>

</html>